/// <reference path="../.sst/platform/config.d.ts" />

import * as fs from 'node:fs';
import * as path from 'node:path';
import { apiRouter } from './api';
import { auth } from './auth';
import { domain } from './dns';
import * as secrets from './secrets';

const PROJECT_NAME = 'tvseries-web';

// Feature flag - enable after verifying Vercel deployment works
const ENABLE_CUSTOM_DOMAINS = false;

// In dev mode, skip Vercel deployment - run Next.js dev server locally
if ($dev) {
  // Generate .env.local with the API/Auth URLs
  $resolve([
    apiRouter.url,
    auth.url,
    secrets.apiKeyRandom.result,
    secrets.sessionSecret.value,
  ]).apply(([apiUrl, authUrl, apiKey, secretKey]) => {
    const envContent = `# Auto-generated by SST dev - do not commit
API_KEY=${apiKey}
API_URL=${apiUrl}
AUTH_URL=${authUrl}
SECRET_KEY=${secretKey}
SITE_URL=http://localhost:3000
`;
    const envPath = path.join(process.cwd(), 'apps/web/.env.local');
    fs.writeFileSync(envPath, envContent);
    console.log(`|  Generated ${envPath} with dev environment variables`);
  });

  // Run Next.js dev server with custom title
  new sst.x.DevCommand('Website', {
    dev: {
      command: 'next dev',
      directory: 'apps/web',
      title: 'Website',
    },
  });
}

export const web = $dev
  ? { url: 'http://localhost:3000' }
  : (() => {
      // Reference existing Vercel project (created via `vercel link`)
      const project = vercel.getProjectOutput({ name: PROJECT_NAME });

      // Get prebuilt output from `vercel build`
      const prebuilt = vercel.getPrebuiltProjectOutput({
        path: 'apps/web',
      });

      // Create deployment from prebuilt files
      const deployment = new vercel.Deployment('WebDeployment', {
        environment: {
          API_KEY: secrets.apiKeyRandom.result,
          API_URL: apiRouter.url,
          AUTH_URL: auth.url,
          SECRET_KEY: secrets.sessionSecret.value,
          SITE_URL: `https://${domain}`,
        },
        files: prebuilt.output,
        pathPrefix: prebuilt.path,
        production: $app.stage === 'production',
        projectId: project.id,
      });

      // Custom domains - enable after testing basic Vercel deployment
      if (ENABLE_CUSTOM_DOMAINS) {
        // Production domain
        if ($app.stage === 'production') {
          new vercel.ProjectDomain('WebDomain', {
            domain: 'tvseri.es',
            projectId: project.id,
          });

          new vercel.ProjectDomain('WebDomainWww', {
            domain: 'www.tvseri.es',
            projectId: project.id,
            redirect: 'tvseri.es',
          });
        }

        // Preview domain alias (e.g., pr-123.dev.tvseri.es)
        if ($app.stage !== 'production' && $app.stage !== 'dev') {
          // Add the subdomain to the project
          new vercel.ProjectDomain('WebPreviewDomain', {
            domain: `${$app.stage}.dev.tvseri.es`,
            projectId: project.id,
          });

          // Alias the deployment to the custom domain
          new vercel.Alias('WebPreviewAlias', {
            alias: `${$app.stage}.dev.tvseri.es`,
            deploymentId: deployment.id,
          });
        }
      }

      return deployment;
    })();
