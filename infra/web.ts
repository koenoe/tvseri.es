/// <reference path="../.sst/platform/config.d.ts" />

import { execSync } from 'node:child_process';
import * as fs from 'node:fs';
import * as path from 'node:path';
import { apiRouter } from './api';
import { auth } from './auth';
import { domain } from './dns';
import * as secrets from './secrets';

const PROJECT_NAME = 'tvseries-web';

// Feature flag - enable after verifying Vercel deployment works
const ENABLE_CUSTOM_DOMAINS = false;

// In dev mode, skip Vercel deployment - run Next.js dev server locally
if ($dev) {
  // Generate .env.local with the API/Auth URLs
  $resolve([
    apiRouter.url,
    auth.url,
    secrets.apiKeyRandom.result,
    secrets.sessionSecret.value,
  ]).apply(([apiUrl, authUrl, apiKey, secretKey]) => {
    const envContent = `# Auto-generated by SST dev - do not commit
API_KEY=${apiKey}
API_URL=${apiUrl}
AUTH_URL=${authUrl}
SECRET_KEY=${secretKey}
SITE_URL=http://localhost:3000
`;
    const envPath = path.join(process.cwd(), 'apps/web/.env.local');
    fs.writeFileSync(envPath, envContent);
    console.log(`|  Generated ${envPath} with dev environment variables`);
  });

  // Run Next.js dev server with custom title
  new sst.x.DevCommand('Website', {
    dev: {
      command: 'next dev',
      directory: 'apps/web',
      title: 'Website',
    },
  });
}

export const web = $dev
  ? { url: 'http://localhost:3000' }
  : (() => {
      const project = vercel.getProjectOutput({ name: PROJECT_NAME });

      // Build the app with env vars from SST resources, then deploy
      const deployment = $resolve([
        apiRouter.url,
        auth.url,
        secrets.apiKeyRandom.result,
        secrets.sessionSecret.value,
        project.id,
      ]).apply(([apiUrl, authUrl, apiKey, secretKey, projectId]) => {
        const siteUrl = `https://${domain}`;
        // Use relative path for Pulumi - absolute for execSync cwd
        const webAppRelative = 'apps/web';
        const webAppPath = path.join(process.cwd(), webAppRelative);
        const isProduction = $app.stage === 'production';
        const environment = isProduction ? 'production' : 'preview';
        const token = process.env.VERCEL_API_TOKEN!;

        // Pull Vercel project settings to apps/web (creates .vercel/project.json)
        console.log('|  Pulling Vercel project settings...');
        execSync(
          `npx vercel pull --yes --environment=${environment} --token=${token}`,
          {
            cwd: webAppPath,
            env: process.env,
            stdio: 'inherit',
          },
        );

        // Run vercel build from apps/web
        console.log('|  Building Next.js app with Vercel CLI...');
        execSync(
          `npx vercel build${isProduction ? ' --prod' : ''} --token=${token}`,
          {
            cwd: webAppPath,
            env: {
              ...process.env,
              API_KEY: apiKey,
              API_URL: apiUrl,
              AUTH_URL: authUrl,
              SECRET_KEY: secretKey,
              SITE_URL: siteUrl,
            },
            stdio: 'inherit',
          },
        );

        // Get prebuilt output from apps/web
        // Note: path must be relative for Pulumi provider to resolve paths correctly
        const prebuilt = vercel.getPrebuiltProjectOutput({
          path: webAppRelative,
        });

        // Create deployment from prebuilt files
        return new vercel.Deployment('WebDeployment', {
          environment: {
            API_KEY: apiKey,
            API_URL: apiUrl,
            AUTH_URL: authUrl,
            SECRET_KEY: secretKey,
            SITE_URL: siteUrl,
          },
          files: prebuilt.output,
          pathPrefix: prebuilt.path,
          production: $app.stage === 'production',
          projectId,
        });
      });

      // Custom domains - enable after testing basic Vercel deployment
      if (ENABLE_CUSTOM_DOMAINS) {
        // Production domain
        if ($app.stage === 'production') {
          new vercel.ProjectDomain('WebDomain', {
            domain: 'tvseri.es',
            projectId: project.id,
          });

          new vercel.ProjectDomain('WebDomainWww', {
            domain: 'www.tvseri.es',
            projectId: project.id,
            redirect: 'tvseri.es',
          });
        }

        // Preview domain alias (e.g., pr-123.dev.tvseri.es)
        if ($app.stage !== 'production' && $app.stage !== 'dev') {
          new vercel.ProjectDomain('WebPreviewDomain', {
            domain: `${$app.stage}.dev.tvseri.es`,
            projectId: project.id,
          });

          new vercel.Alias('WebPreviewAlias', {
            alias: `${$app.stage}.dev.tvseri.es`,
            deploymentId: deployment.id,
          });
        }
      }

      return deployment;
    })();
