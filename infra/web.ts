/// <reference path="../.sst/platform/config.d.ts" />

import { execSync } from 'node:child_process';
import * as fs from 'node:fs';
import * as path from 'node:path';
import { apiRouter } from './api';
import { auth } from './auth';
import { domain, zone } from './dns';
import * as secrets from './secrets';

// Validate Vercel credentials upfront for clearer error messages
const VERCEL_TOKEN = process.env.VERCEL_API_TOKEN;
const VERCEL_TEAM_ID = process.env.VERCEL_TEAM_ID;
if (!$dev && !VERCEL_TOKEN) {
  throw new Error('VERCEL_API_TOKEN environment variable is required');
}

const isProduction = $app.stage === 'production';
const customDomain = isProduction ? 'www.tvseri.es' : domain;
const siteUrl = `https://${customDomain}`;

// Helper to run Vercel CLI commands
function runVercel(
  command: string,
  projectId: string,
  options: { env?: Record<string, string>; capture?: boolean } = {},
) {
  const scopeFlag = VERCEL_TEAM_ID ? ` --scope=${VERCEL_TEAM_ID}` : '';
  const fullCommand = `npx vercel ${command}${scopeFlag} --token=${VERCEL_TOKEN}`;

  return execSync(fullCommand, {
    cwd: process.cwd(),
    encoding: 'utf-8',
    env: {
      ...process.env,
      ...options.env,
      VERCEL_PROJECT_ID: projectId,
    },
    stdio: options.capture ? 'pipe' : 'inherit',
  });
}

// Dev mode: run Next.js locally
if ($dev) {
  $resolve([
    apiRouter.url,
    auth.url,
    secrets.apiKeyRandom.result,
    secrets.sessionSecret.value,
  ]).apply(([apiUrl, authUrl, apiKey, secretKey]) => {
    const envContent = `# Auto-generated by SST dev - do not commit
API_KEY=${apiKey}
API_URL=${apiUrl}
AUTH_URL=${authUrl}
SECRET_KEY=${secretKey}
`;
    const envPath = path.join(process.cwd(), 'apps/web/.env.local');
    fs.writeFileSync(envPath, envContent);
    console.log(`|  Generated ${envPath}`);
  });

  new sst.x.DevCommand('Website', {
    dev: {
      command: 'next dev',
      directory: 'apps/web',
      title: 'Website',
    },
  });
}

// Deployed environments: Vercel
export const web = $dev
  ? { url: 'http://localhost:3000' }
  : (() => {
      const project = new vercel.Project('WebProject', {
        framework: 'nextjs',
        name: 'tvseries-web',
        resourceConfig: {
          // Note: is a pro feature
          // functionDefaultRegions: ['iad1', 'lhr1'],
        },
        rootDirectory: 'apps/web',
      });

      // TODO: enable when it works in Pulumi, currently is broken
      // new vercel.FirewallConfig('WebFirewallConfig', {
      //   enabled: true,
      //   managedRulesets: {
      //     aiBots: {
      //       action: 'deny',
      //       active: true,
      //     },
      //     botProtection: {
      //       action: 'challenge',
      //       active: true,
      //     },
      //   },
      //   projectId: project.id,
      // });

      const vercelTarget = isProduction ? 'production' : 'preview';

      // Environment variables for Vercel project
      const envVars = [
        new vercel.ProjectEnvironmentVariable('WebEnvApiKey', {
          key: 'API_KEY',
          projectId: project.id,
          sensitive: true,
          targets: [vercelTarget],
          value: secrets.apiKeyRandom.result,
        }),
        new vercel.ProjectEnvironmentVariable('WebEnvApiUrl', {
          key: 'API_URL',
          projectId: project.id,
          targets: [vercelTarget],
          value: apiRouter.url,
        }),
        new vercel.ProjectEnvironmentVariable('WebEnvAuthUrl', {
          key: 'AUTH_URL',
          projectId: project.id,
          targets: [vercelTarget],
          value: auth.url,
        }),
        new vercel.ProjectEnvironmentVariable('WebEnvSecretKey', {
          key: 'SECRET_KEY',
          projectId: project.id,
          sensitive: true,
          targets: [vercelTarget],
          value: secrets.sessionSecret.value,
        }),
        new vercel.ProjectEnvironmentVariable('WebEnvSiteUrl', {
          key: 'SITE_URL',
          projectId: project.id,
          targets: [vercelTarget],
          value: siteUrl,
        }),
      ];

      // Build and deploy
      const deployedUrl = $resolve([
        apiRouter.url,
        auth.url,
        secrets.apiKeyRandom.result,
        secrets.sessionSecret.value,
        project.id,
        ...envVars.map((e) => e.id),
      ]).apply(([apiUrl, authUrl, apiKey, secretKey, projectId]) => {
        const prodFlag = isProduction ? ' --prod' : '';
        const environment = isProduction ? 'production' : 'preview';

        console.log('|  Pulling Vercel project settings...');
        runVercel(`pull --yes --environment=${environment}`, projectId);

        console.log('|  Building Next.js app...');
        runVercel(`build${prodFlag}`, projectId, {
          env: {
            API_KEY: apiKey,
            API_URL: apiUrl,
            AUTH_URL: authUrl,
            SECRET_KEY: secretKey,
            SITE_URL: siteUrl,
          },
        });

        console.log('|  Deploying to Vercel...');
        const deploymentUrl = runVercel(
          `deploy --prebuilt${prodFlag} --archive=tgz`,
          projectId,
          { capture: true },
        ).trim();
        console.log(`|  Deployed to ${deploymentUrl}`);

        // Set alias for deployment
        runVercel(`alias set ${deploymentUrl} ${customDomain}`, projectId);
        console.log(`|  Live at ${siteUrl}`);

        return siteUrl;
      });

      // DNS configuration
      if (isProduction) {
        // www.tvseri.es -> Vercel
        new vercel.ProjectDomain('WebDomainWww', {
          domain: 'www.tvseri.es',
          projectId: project.id,
        });

        new aws.route53.Record('WwwVercelRecord', {
          name: 'www.tvseri.es',
          records: ['cname.vercel-dns.com'],
          ttl: 300,
          type: 'CNAME',
          zoneId: zone,
        });

        // tvseri.es -> redirect to www via CloudFront Function
        const redirectFunction = new aws.cloudfront.Function(
          'ApexRedirectFunction',
          {
            code: `function handler(event) {
  return {
    statusCode: 301,
    statusDescription: 'Moved Permanently',
    headers: { location: { value: 'https://www.tvseri.es' + event.request.uri } }
  };
}`,
            name: 'tvseries-apex-redirect-to-www',
            runtime: 'cloudfront-js-2.0',
          },
        );

        const apexCert = aws.acm.getCertificateOutput({
          domain: 'tvseri.es',
          statuses: ['ISSUED'],
        });

        const apexRedirect = new aws.cloudfront.Distribution('ApexRedirect', {
          aliases: ['tvseri.es'],
          defaultCacheBehavior: {
            allowedMethods: ['GET', 'HEAD'],
            cachedMethods: ['GET', 'HEAD'],
            forwardedValues: {
              cookies: { forward: 'none' },
              queryString: false,
            },
            functionAssociations: [
              {
                eventType: 'viewer-request',
                functionArn: redirectFunction.arn,
              },
            ],
            targetOriginId: 'dummy',
            viewerProtocolPolicy: 'redirect-to-https',
          },
          enabled: true,
          origins: [
            {
              customOriginConfig: {
                httpPort: 80,
                httpsPort: 443,
                originProtocolPolicy: 'https-only',
                originSslProtocols: ['TLSv1.2'],
              },
              domainName: 'www.tvseri.es',
              originId: 'dummy',
            },
          ],
          restrictions: { geoRestriction: { restrictionType: 'none' } },
          viewerCertificate: {
            acmCertificateArn: apexCert.arn,
            minimumProtocolVersion: 'TLSv1.2_2021',
            sslSupportMethod: 'sni-only',
          },
        });

        // A and AAAA records for apex
        new aws.route53.Record('ApexRedirectRecord', {
          aliases: [
            {
              evaluateTargetHealth: false,
              name: apexRedirect.domainName,
              zoneId: apexRedirect.hostedZoneId,
            },
          ],
          name: 'tvseri.es',
          type: 'A',
          zoneId: zone,
        });

        new aws.route53.Record('ApexRedirectRecordAAAA', {
          aliases: [
            {
              evaluateTargetHealth: false,
              name: apexRedirect.domainName,
              zoneId: apexRedirect.hostedZoneId,
            },
          ],
          name: 'tvseri.es',
          type: 'AAAA',
          zoneId: zone,
        });
      } else {
        // Preview: pr-{n}.dev.tvseri.es -> Vercel
        new aws.route53.Record('PreviewWebRecord', {
          name: domain,
          records: ['cname.vercel-dns.com'],
          ttl: 300,
          type: 'CNAME',
          zoneId: zone,
        });
      }

      return { url: deployedUrl };
    })();
